<div id="widget-chat">

    <div class="stuck" id="panel-mensajes">

    </div>

    <div class="grid-container">
        <div class="item1">
            <input type="text" class="form-control" placeholder="Escribir mensaje"
                   id="escribir-mensaje"/>
        </div>
        <div class="item2">
            <button onclick="insertarMensaje()" class="btn btn-primary">Enviar</button>
        </div>
    </div>

</div>

<script>

    window.history.pushState("", "", "/cliente.html?w=chat");

    var numberOfUpdates = 0;

    //Move scroll to bottom
    function updateScroll() {
        var element = document.getElementById("panel-mensajes");
        var elementHeight = element.scrollHeight;
        element.scrollTop = elementHeight
    }

    setInterval(function () {
        mostrarMensajes();
    }, 1000);

    /**
     * Mostrar mensajes
     */
    function mostrarMensajes() {
        $.ajax({
            url: URLbase + "/mensaje?usuarioFrom=" + loggedUserEmail + "&usuarioTo=" + chattingWithEmail,
            type: "GET",
            data: {},
            dataType: 'json',
            headers: {
                "token": token
            },
            success: function (mensajes) {
                //Vaciar mensajes
                $("#panel-mensajes").empty();
                //Cargarlos y a√±adirlos de nuevo
                for (i = 0; i < mensajes.length; i++) {
                    if (loggedUserEmail == mensajes[i].usuarioFrom)
                        $("#panel-mensajes").append(
                            "<h5 id=" + mensajes[i]._id + " align=\"right\" class='alert alert-success'>" + mensajes[i].contenido + "</h5>");
                    else
                        $("#panel-mensajes").append(
                            "<h5 id=" + mensajes[i]._id + " align=\"left\" class='alert alert-info'>" + mensajes[i].contenido + "</h5>");
                }
                if (numberOfUpdates < 1)
                    updateScroll();
                numberOfUpdates++;
            },
            error: function (error) {
                console.log(error);
            }
        });
    }

    mostrarMensajes();

    /**
     * Insertar mensaje
     */
    function insertarMensaje() {

        var mensaje = {
            usuarioTo: chattingWithEmail,
            contenido: $("#escribir-mensaje").val(),
        };
        $.ajax({
            url: URLbase + "/mensaje",
            type: "POST",
            data: mensaje,
            dataType: 'json',
            headers: {"token": token},
            success: function (response) {
                console.log("Mensaje enviado");
                $("#escribir-mensaje").val("");
                //Bajar la barra pa bajo pa que se vea el mensaje nuevo
                window.setTimeout("updateScroll()", 2000);
            },
            error: function (error) {
                console.log(error);
            }
        });
    }

</script>