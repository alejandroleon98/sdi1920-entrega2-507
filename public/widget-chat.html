<div id="widget-chat">
    <h4 class="light" id="ususario-chateando">Chat con: </h4>

    <div class="stuck" id="panel-mensajes">

    </div>

    <div class="grid-container">
        <div class="item1">
            <input type="text" class="form-control" placeholder="Escribir mensaje"
                   id="escribir-mensaje"/>
        </div>
        <div class="item2">
            <button id="botonEnviarMensaje" onclick="insertarMensaje()" class="btn btn-primary">Enviar</button>
        </div>
    </div>

</div>

<script>

    window.history.pushState("", "", "/cliente.html?w=chat");

    var numberOfUpdates = 0;
    var hayQueDesplazarseHaciaAbajo = false;

    //Mover scrollbar hasta abajo para que el usuario vea los mensajes de abajo directamente
    //como en whatsapp por ejemplo
    function updateScroll() {
        var element = document.getElementById("panel-mensajes");
        var elementHeight = element.scrollHeight;
        element.scrollTop = elementHeight
    }

    //Intervalo para que se actualize automáticamente la lista de mensajes
    setInterval(function () {
        // Para que no se actualice cuando no se eté en la url amigos
        var url = new URL(window.location.href);
        var w = url.searchParams.get("w");
        if (w == "chat")
            mostrarMensajes();
    }, 1000);

    //Para que al pulsar enter se envie el mensaje
    var input = document.getElementById("escribir-mensaje");
    input.addEventListener("keyup", function (event) {
        if (event.keyCode === 13) {
            event.preventDefault();
            document.getElementById("botonEnviarMensaje").click();
        }
    });

    //Chat con...
    $('#ususario-chateando').append(chattingWithEmail);

    /**
     * Mostrar mensajes
     */
    function mostrarMensajes() {
        $.ajax({
            url: URLbase + "/mensaje?usuarioFrom=" + loggedUserEmail + "&usuarioTo=" + chattingWithEmail,
            type: "GET",
            data: {},
            dataType: 'json',
            headers: {
                "token": token
            },
            success: function (mensajes) {
                //Vaciar mensajes
                $("#panel-mensajes").empty();
                //Cargarlos y añadirlos de nuevo
                for (i = 0; i < mensajes.length; i++) {
                    if (loggedUserEmail == mensajes[i].usuarioFrom)
                        $("#panel-mensajes").append(
                            "<h5 id=" + mensajes[i]._id + " align=\"right\" class='alert alert-success'>" + (mensajes[i].leido ? ' ✔' : '') + mensajes[i].contenido + "</h5>");
                    else
                        $("#panel-mensajes").append(
                            "<h5 id=" + mensajes[i]._id + " align=\"left\" class='alert alert-info'>" + mensajes[i].contenido + (mensajes[i].leido ? ' ✔' : '') + "</h5>");
                }
                if (numberOfUpdates < 1) {
                    updateScroll();
                    numberOfUpdates++;
                }
                if (hayQueDesplazarseHaciaAbajo) {
                    updateScroll();
                    hayQueDesplazarseHaciaAbajo = false;
                }
                marcarComoLeidos();
            },
            error: function (error) {
                console.log(error);
            }
        });
    }

    mostrarMensajes();

    /**
     * Insertar mensaje
     */
    function insertarMensaje() {

        var mensaje = {
            usuarioTo: chattingWithEmail,
            contenido: $("#escribir-mensaje").val(),
        };
        $("#escribir-mensaje").val("");
        $.ajax({
            url: URLbase + "/mensaje",
            type: "POST",
            data: mensaje,
            dataType: 'json',
            headers: {"token": token},
            success: function (response) {
                console.log("Mensaje enviado");
                //Bajar la barra pa bajo pa que se vea el mensaje nuevo
                hayQueDesplazarseHaciaAbajo = true;
            },
            error: function (error) {
                console.log(error);
                $("#contenedor-principal").load("widget-login.html");
            }
        });
    }

    /**
     * Marcar como leídos todos los mensajes recibidos por el usuario en sesión
     * y enviados por el usuario en el que se haya entrado en la conversación con el.
     */
    function marcarComoLeidos() {
        var data = {
            usuarioFrom: chattingWithEmail,
        };
        $.ajax({
            url: URLbase + "/mensaje",
            type: "PUT",
            data: data,
            dataType: 'json',
            headers: {"token": token},
            success: function (response) {
                console.log("Mensajes recibidos marcados como leidos");
            },
            error: function (error) {
                console.log(error);
                $("#contenedor-principal").load("widget-login.html");
            }
        });
    }

</script>